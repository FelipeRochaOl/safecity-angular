<div class="chatbot-container">
  <!-- Header -->
  <div class="chat-header">
    <div class="d-flex justify-content-between align-items-center">
      <h2 class="mb-0">
        <i class="fas fa-robot me-2"></i>
        ChatBot DB - IA Generativa
      </h2>
      <div>
        <button class="btn btn-outline-light btn-sm me-2" routerLink="/dashboard">
          <i class="fas fa-arrow-left me-1"></i>
          Dashboard
        </button>
        <button class="btn btn-outline-light btn-sm me-2" (click)="clearConversation()">
          <i class="fas fa-trash me-1"></i>
          Limpar
        </button>
        <button class="btn btn-outline-danger btn-sm" (click)="logout()">
          <i class="fas fa-sign-out-alt me-1"></i>
          Sair
        </button>
      </div>
    </div>
  </div>

  <div class="chat-body">
    <!-- Sidebar with Stats -->
    <div class="chat-sidebar">
      <div class="card mb-3">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0">
            <i class="fas fa-chart-bar me-2"></i>
            Estatísticas Rápidas
          </h6>
        </div>
        <div class="card-body" *ngIf="quickStats">
          <div class="stat-item">
            <i class="fas fa-exclamation-triangle text-warning"></i>
            <div>
              <div class="stat-label">Total de Incidentes</div>
              <div class="stat-value">{{ quickStats.totalIncidents }}</div>
            </div>
          </div>
          <div class="stat-item">
            <i class="fas fa-clock text-info"></i>
            <div>
              <div class="stat-label">Pendentes</div>
              <div class="stat-value">{{ quickStats.pendingIncidents }}</div>
            </div>
          </div>
          <div class="stat-item">
            <i class="fas fa-users text-success"></i>
            <div>
              <div class="stat-label">Usuários</div>
              <div class="stat-value">{{ quickStats.totalUsers }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Suggested Questions -->
      <div class="card" *ngIf="showWelcome">
        <div class="card-header bg-secondary text-white">
          <h6 class="mb-0">
            <i class="fas fa-lightbulb me-2"></i>
            Perguntas Sugeridas
          </h6>
        </div>
        <div class="card-body p-2">
          <div class="suggested-questions">
            <button
              *ngFor="let question of suggestedQuestions"
              class="btn btn-sm btn-outline-primary w-100 mb-2 text-start"
              (click)="useSuggestedQuestion(question)"
            >
              <i class="fas fa-comment-dots me-2"></i>
              {{ question }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Messages -->
    <div class="chat-main">
      <div class="messages-container" #messagesContainer>
        <div *ngFor="let message of messages" class="message" [class.user-message]="message.role === 'user'" [class.assistant-message]="message.role === 'assistant'">
          <div class="message-avatar">
            <i *ngIf="message.role === 'user'" class="fas fa-user"></i>
            <i *ngIf="message.role === 'assistant'" class="fas fa-robot"></i>
          </div>
          <div class="message-content">
            <div class="message-header">
              <span class="message-role">{{ message.role === 'user' ? 'Você' : 'Assistente' }}</span>
              <span class="message-time">{{ message.timestamp | date: 'short' }}</span>
            </div>
            <div class="message-text">
              {{ message.content }}
            </div>

            <!-- SQL Query Display -->
            <div *ngIf="message.sqlQuery" class="sql-query mt-2">
              <div class="sql-header">
                <i class="fas fa-database me-2"></i>
                Consulta SQL Executada:
              </div>
              <pre class="sql-code"><code>{{ message.sqlQuery }}</code></pre>
            </div>

            <!-- Data Display -->
            <div *ngIf="message.data && isArray(message.data)" class="data-result mt-2">
              <div class="data-header">
                <i class="fas fa-table me-2"></i>
                Resultados ({{ message.data.length }} registro{{ message.data.length !== 1 ? 's' : '' }}):
              </div>
              <div class="table-responsive">
                <table class="table table-sm table-striped table-hover">
                  <thead>
                    <tr>
                      <th *ngFor="let key of getObjectKeys(message.data[0])">{{ key }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let row of message.data">
                      <td *ngFor="let key of getObjectKeys(row)">{{ row[key] }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Error Display -->
            <div *ngIf="message.error" class="alert alert-danger mt-2 mb-0">
              <i class="fas fa-exclamation-triangle me-2"></i>
              {{ message.error }}
            </div>
          </div>
        </div>

        <!-- Typing Indicator -->
        <div *ngIf="isTyping" class="message assistant-message">
          <div class="message-avatar">
            <i class="fas fa-robot"></i>
          </div>
          <div class="message-content">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="input-area">
        <div class="input-group">
          <input
            type="text"
            class="form-control"
            placeholder="Digite sua pergunta sobre o banco de dados..."
            [(ngModel)]="currentMessage"
            (keyup.enter)="sendMessage()"
            [disabled]="isLoading"
          />
          <button
            class="btn btn-primary"
            (click)="sendMessage()"
            [disabled]="isLoading || !currentMessage.trim()"
          >
            <i class="fas fa-paper-plane me-2" *ngIf="!isLoading"></i>
            <span class="spinner-border spinner-border-sm me-2" *ngIf="isLoading"></span>
            {{ isLoading ? 'Processando...' : 'Enviar' }}
          </button>
        </div>
        <div class="input-hint">
          <i class="fas fa-info-circle me-2"></i>
          Faça perguntas sobre incidentes, estatísticas, áreas de risco e muito mais!
        </div>
      </div>
    </div>
  </div>
</div>
